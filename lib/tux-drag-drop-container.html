<!--
@license
Copyright (c) 2015 Tux Authors
This code is distributed under the MIT license.  See LICENSE.txt for
details.
-->
<link rel="import" href="../../polymer/polymer.html">
<dom-module id='tux-drag-drop-container'>
  <template>
    <style>
    #wrapper:empty {
      border: 1px solid rgba(0, 0, 0, 0.1);
      background-color: rgba(0,0,0,0.025);
      min-height: 10px;
      min-width: 100%;
      box-sizing: border-box;
      @apply(--wrapper);
    }
    </style>
    <div id='wrapper' class='tux-drag-drop-container-wrapper' zones='[[zones]]'>
      <content></content>
    </div>
  </template>
  <script>
    /**
    * rewraps content contents of an element into a
    * new element
    * old {element} The element to rewrap
    * new {string} Name of the new tag to replace  old with
    * returns the new element
    */
    Polymer({
      is: 'tux-drag-drop-container',
      properties: {
        drake: {
          type: String,
          notify: true,
          value: null
        },
      	selector: {
          type: String,
          notify: true,
          value: null,
      	},
        for: {
          type: String,
          notify: true,
          value: null
        },
        zones: {
          type: String,
          notify: true,
          value: null
        },
        wrapper: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          value: 'div',
        },
        copy: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: false
        },
      },

      listeners: { 'drop' : '_contentChanged' },
      observers: [ '_zonesChange(zones, for)' ],

      isReady: false,

      _zonesChange: function (z, f) {
        var target = this.querySelector(this.for ? this.for :
          '.tux-drag-drop-container');
        if (this.zones)
          target.zones = this.zones;
        if (this.drake)  {
          var drakeInstance = document.querySelector(this.drake);
          if(drakeInstance) {
            drakeInstance.register(target);
          }
        }
      },

      _contentChanged: function(e) {
        if(this.$.wrapper.children.length === 0 ) {
          this.$.wrapper.innerHTML = '';
        }
      },
      ready: function() {
        if(this.drake === null){
          throw new Error('<tux-drag-drop-container> without a corrosponding drake');
        }
        this.isReady = true;
      },
      attached: function() {
        if(this.$.wrapper.children.length === 0 ) {
          this.$.wrapper.innerHTML = '';
        }
        this.register();
      },
      detached: function() {
        this.unregister();
      },
      register: function() {
        this.drake.split(/[,|\s]+/).forEach(function(drakeId) {
          var drakeInstance = document.querySelector(drakeId);
          if(drakeInstance) {
            var target = this.for ? this.parentNode.querySelector(this.for) : this.$.wrapper;
            Polymer.dom(target).classList.add('tux-drag-drop-container')
            drakeInstance.register(this, target);
          }
        }, this);
      },
      unregister: function() {
        var drake = document.querySelector(this.drake);
        var target = this.for ? this.parentNode.querySelector(this.for) : this.$.wrapper;
        Polymer.dom(target).classList.remove('tux-drag-drop-container')
        drake.unregister(this, target);
      }
    });
  </script>
</dom-module>
